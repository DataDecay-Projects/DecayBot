<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blockly Command Generator</title>
  <!-- Load Blockly core -->
<script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
<!-- Load the default blocks -->
<script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
<!-- Load a generator -->
<script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
<!-- Load a message file -->
<script src="https://unpkg.com/blockly/msg/en.js"></script>
  <style>
    #blocklyDiv { height: 480px; width: 600px; }
    #jsonOutput { white-space: pre-wrap; font-family: monospace; margin-top: 20px; }
  </style>
</head>
<body>

  <h1>Blockly Command Generator</h1>
  <div id="blocklyDiv"></div>
  <button onclick="generateJSON()">Generate commands.json</button>
  <pre id="jsonOutput"></pre>

  <script>
    Blockly.Blocks['command_name'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Command Name")
            .appendField(new Blockly.FieldTextInput("command_name"), "NAME");
        this.setOutput(true, "String");
        this.setColour(160);
        this.setTooltip("Set the name of the command");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['add_role'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Role")
            .appendField(new Blockly.FieldTextInput("role_name"), "ROLE");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("Add a role to the command");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['add_action_chat'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Chat Message")
            .appendField(new Blockly.FieldTextInput("Hello World!"), "MESSAGE");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("Send a chat message");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['add_action_mute'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Mute Player")
            .appendField(new Blockly.FieldTextInput("player_name"), "PLAYER");
        this.appendValueInput("DURATION")
            .setCheck("Number")
            .appendField("Duration (ms)");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("Mute a player for a specific duration");
        this.setHelpUrl("");
      }
    };

    function generateJSON() {
      var jsonOutput = [];
      var commandBlocks = Blockly.getMainWorkspace().getBlocksByType('command_name');

      commandBlocks.forEach(function(commandBlock) {
        var commandName = commandBlock.getFieldValue('NAME');
        var roles = [];
        var actions = [];

        // Collect roles
        var roleBlocks = commandBlock.getChildren().filter(block => block.type === 'add_role');
        roleBlocks.forEach(function(roleBlock) {
          roles.push(roleBlock.getFieldValue('ROLE'));
        });

        // Collect actions
        var actionBlocks = commandBlock.getChildren().filter(block => block.type.startsWith('add_action'));
        actionBlocks.forEach(function(actionBlock) {
          var action = {};
          switch (actionBlock.type) {
            case 'add_action_chat':
              action.type = "chat";
              action.message = actionBlock.getFieldValue('MESSAGE');
              break;
            case 'add_action_mute':
              action.type = "mute";
              action.player = actionBlock.getFieldValue('PLAYER');
              action.duration = actionBlock.getFieldValue('DURATION');
              break;
          }
          actions.push(action);
        });

        // Build the command object
        jsonOutput.push({
          name: commandName,
          roles: roles,
          actions: actions
        });
      });

      // Show the generated JSON
      document.getElementById('jsonOutput').textContent = JSON.stringify(jsonOutput, null, 2);
    }

    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: `
        <xml>
          <block type="command_name"></block>
        </xml>
      `,
      scrollbars: true,
      grid: { spacing: 20, length: 3, colour: '#ccc', snap: true }
    });

    // Dynamically add blocks to create new commands and actions
    function addNewCommand() {
      var newCommandBlock = Blockly.Xml.textToDom('<xml><block type="command_name"></block></xml>');
      Blockly.Xml.domToWorkspace(newCommandBlock, workspace);
    }

    // Adding a button to dynamically add new commands
    var addCommandButton = document.createElement("button");
    addCommandButton.innerHTML = "Add New Command";
    addCommandButton.onclick = addNewCommand;
    document.body.appendChild(addCommandButton);

  </script>
</body>
</html>
